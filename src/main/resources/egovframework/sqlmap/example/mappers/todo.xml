<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="ants.com.board.manageBoard.mapper.ManageBoardMapper">
	
	<!--mem : 할일 리스트 조회 -->
	<select id="getMyTodoList" parameterType="ants.com.board.manageBoard.model.TodoVo"
		resultType="ants.com.board.manageBoard.model.TodoVo">
		SELECT c.*
			FROM (
				SELECT
				ROWNUM rnum, a.*
				FROM (select * from (SELECT
					todo.todo_id,
					ABS(TO_DATE(TO_CHAR(todo.todo_start, 'YYYYMMDD')) -
					To_date(to_char(SYSDATE,'yyyymmdd'))) as todo_start,
					TO_DATE(TO_CHAR(SYSDATE, 'yyyymmdd')) -
					To_date(to_char(todo.todo_end,'yyyymmdd')) as todo_end,
					todo.todo_cont,
					todo_title,
					todo.todo_percent,
					todo.todo_importance,
					todo.todo_level,
					todo.req_id,
					todo.todo_parentid,
					todo.del,
					member.mem_name AS mem_id
				FROM( select *
					from member)member, todo todo
				WHERE
					member.mem_id = todo.mem_id
				AND
					todo.del = 'N'
				AND todo.req_id = #{reqId} 
				AND member.mem_id = #{memId} 
					<if test="searchKeyword != null and searchKeyword != ''">
						<choose>
							<when test="searchCondition == 1">
								AND member.mem_name LIKE '%' || #{searchKeyword} || '%'
							</when>
							<when test="searchCondition == 2">
								AND todo.todo_cont LIKE '%' || #{searchKeyword} || '%'
							</when>
							<when test="searchCondition == 3">
								AND todo.todo_title LIKE '%' || #{searchKeyword} || '%'
							</when>
						</choose>
					</if>
				order by todo_id desc))a
				WHERE rownum  <![CDATA[ <= ]]> #{lastIndex}) c
        		<![CDATA[WHERE rnum > #{firstIndex}]]>
		
		
		</select>
	<!--PL : 할일 리스트 조회 -->
	<select id="getTodoList"
		parameterType="ants.com.board.manageBoard.model.TodoVo"
		resultType="ants.com.board.manageBoard.model.TodoVo">

		SELECT c.*
			FROM (
				SELECT
				ROWNUM rnum, a.*
				FROM (select * from (SELECT
					todo.todo_id,
					ABS(TO_DATE(TO_CHAR(todo.todo_start, 'YYYYMMDD')) -
					To_date(to_char(SYSDATE,'yyyymmdd'))) as todo_start,
					TO_DATE(TO_CHAR(SYSDATE, 'yyyymmdd')) -
					To_date(to_char(todo.todo_end,'yyyymmdd')) as todo_end,
					todo.todo_cont,
					todo_title,
					todo.todo_percent,
					todo.todo_importance,
					todo.todo_level,
					todo.req_id,
					todo.todo_parentid,
					todo.del,
					member.mem_name AS mem_id
				FROM( select *
					from member)member, todo todo
				WHERE
					member.mem_id = todo.mem_id
				AND
					todo.del = 'N'
				AND todo.req_id = #{reqId} 
					<if test="searchKeyword != null and searchKeyword != ''">
						<choose>
							<when test="searchCondition == 1">
								AND member.mem_name LIKE '%' || #{searchKeyword} || '%'
							</when>
							<when test="searchCondition == 2">
								AND todo.todo_cont LIKE '%' || #{searchKeyword} || '%'
							</when>
							<when test="searchCondition == 3">
								AND todo.todo_title LIKE '%' || #{searchKeyword} || '%'
							</when>
						</choose>
					</if>
				order by todo_id desc))a
				WHERE rownum  <![CDATA[ <= ]]> #{lastIndex}) c
        		<![CDATA[WHERE rnum > #{firstIndex}]]>
		</select>

	<!-- 페이지처리위한 요구사항개수 -->
		<select id="todoListCount" parameterType="String"
			resultType="java.lang.Integer">
			<![CDATA[
				SELECT COUNT(*)
					FROM todo
					WHERE req_id = #{reqId}
					AND del = 'N'
		    ]]>
		</select>
		
	<!-- 내일감 페이지 천리를 위한 요구사항개수 -->
		<select id="todoMyListCount" parameterType="String"
			resultType="java.lang.Integer">
			<![CDATA[
				SELECT COUNT(*)
					FROM todo
					WHERE req_id = #{reqId}
					AND mem_id= #{memId}
					AND del = 'N'
		    ]]>
		</select>

	<!-- 한개의 할일 조회 -->
		<select id="getTodo"
			parameterType="ants.com.board.manageBoard.model.TodoVo"
			resultType="ants.com.board.manageBoard.model.TodoVo">
			<![CDATA[
			SELECT
			    todo.todo_id,
			    TO_CHAR(todo.todo_start,'yyyy/mm/dd') as todo_start,
			    TO_CHAR(todo.todo_end,'yyyy/mm/dd') as todo_end,
			    todo.todo_cont,
			    todo.todo_title,
			    todo.todo_percent,
			    todo_importance,
			    todo_level,
			    todo.req_id,
			    todo.todo_parentid,
			    todo.del,
			    todo.mem_id
			FROM todo todo
			WHERE todo.todo_id = #{todoId}
            or   todo.todo_parentid = #{todoId} 
			]]>
		</select>
		
	<!-- 한개의 할일 조회 -->
		<select id="mygetTodo"
			parameterType="ants.com.board.manageBoard.model.TodoVo"
			resultType="ants.com.board.manageBoard.model.TodoVo">
			<![CDATA[
			SELECT
			    todo.todo_id,
			    TO_CHAR(todo.todo_start,'yyyy/mm/dd') as todo_start,
			    TO_CHAR(todo.todo_end,'yyyy/mm/dd') as todo_end,
			    todo.todo_cont,
			    todo.todo_title,
			    todo.todo_percent,
			    todo_importance,
			    todo_level,
			    todo.req_id,
			    todo.todo_parentid,
			    todo.del,
			    todo.mem_id
			FROM todo todo
			WHERE todo.todo_id = #{todoId}
			]]>
		</select>


	<!-- 팀원 조회 -->
		<select id="projectMemList"
			parameterType="ants.com.board.manageBoard.model.TodoVo"
			resultType="ants.com.member.model.MemberVo">
			SELECT
				member.mem_name,
				member.mem_id,
				projectmember.promem_id
			FROM
				member,
				projectmember
			WHERE
				member.mem_id =
				projectmember.mem_id
			AND projectmember.req_id = #{reqId}
			AND projectmember.promem_status = 'IN'
		</select>


	<!-- 일감 생성 -->
		<insert id="todoInsert"
			parameterType="ants.com.board.manageBoard.model.TodoVo">
			INSERT INTO todo (
				todo_id,
				todo_start,
				todo_end,
				TODO_CONT,
				todo_title,
				todo_percent,
				todo_importance,
				todo_level,
				req_id,
				mem_id,
				todo_parentid,
				del
			) VALUES (
				todo_seq.nextval,
				TO_DATE(#{todoStart},'YYYY/MM/DD'),
				TO_DATE(#{todoEnd},'YYYY/MM/DD'),
				#{todoCont},
				#{todoTitle},
				'0',
				#{todoImportance},
				#{todoLevel},
				#{reqId},
				#{memId},
				#{todoParentid, jdbcType=VARCHAR},
				'N'
			)
			
			<selectKey keyProperty="todoId" resultType="String">
			select todo_seq.currval from dual
		</selectKey>
		</insert>


		<!-- 진행도 작성 -->
		<update id="progressChange"
			parameterType="ants.com.board.manageBoard.model.TodoVo">
			UPDATE todo
			SET
				todo_percent =#{todoPercent}
			WHERE
				todo_id = #{todoId}
		</update>
		
		<!-- 일감수정 -->
		<update id="todoupdate"
			parameterType="ants.com.board.manageBoard.model.TodoVo">
			UPDATE todo
			SET
				todo_start = TO_DATE(#{todoStart},
				'YYYY/MM/DD'),
				todo_end = TO_DATE(#{todoEnd}, 'YYYY/MM/DD'),
				todo_cont =#{todoCont},
				todo_title =#{todoTitle},
				todo_percent =#{todoPercent},
				todo_importance =#{todoImportance},
				todo_level ='1',
				mem_id= #{memId}
			WHERE
				todo_id = #{todoId}
		</update>
	
		<!-- 일감 삭제 -->
		<update id="tododelete"
			parameterType="ants.com.board.manageBoard.model.TodoVo">
			UPDATE todo
				SET del='Y'
				WHERE
				todo_id = #{todoId}
		</update>
	
		<insert id="todoChangeMem"
			parameterType="ants.com.board.manageBoard.model.TodoLogVo">
			INSERT INTO todolog (
				todo_id,
				log_id,
				log_comment,
				before_id,
				after_id,
				reg_dt
			) VALUES (
				#{todoId},
				LOG_SEQ.NEXTVAL,
				#{logComment},
				#{beforeId},
				#{afterId},
				sysdate
			)
		</insert>
		
		<select id="projectList" parameterType="ants.com.member.model.ProjectVo"
		resultType="ants.com.member.model.ProjectVo">
		select * from project where mem_id= #{memId} and req_id = #{reqId}
		</select>
</mapper>