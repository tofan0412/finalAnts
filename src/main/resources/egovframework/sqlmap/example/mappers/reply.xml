<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ants.com.board.memBoard.mapper.memBoardMapper">

	<!-- 댓글 등록 -->
	<insert id="insertreply" parameterType="ants.com.board.memBoard.model.ReplyVo">
		INSERT INTO reply VALUES(reply_seq.nextval,#{someId}, #{replyCont}, sysdate,'N', #{categoryId}, #{reqId}, #{memId})
	</insert>
	

  <!-- 댓글목록 가져오기 -->
  <select id="replylist" resultType="ants.com.board.memBoard.model.ReplyVo" parameterType="String">
    SELECT  reply_id,
		    some_id,
		    reply_cont,
		    to_char(reg_dt,'yyyy-mm-dd hh:mm') as reg_dt ,
		    del,
		    category_id,
		    req_id,
		    mem_id
    FROM reply
    WHERE some_id = #{someId}
      and req_id = #{reqId}
      and category_id = #{categoryId}
    order by reg_dt
  </select>
  
  
   <!-- 댓글 삭제 status Y으로-->
  <update id="delreply" parameterType="ants.com.board.memBoard.model.ReplyVo">
  	UPDATE reply 
  	SET del = 'Y' 
  	WHERE reply_id = #{replyId} 
  </update>
  
  	<!-- 로그인한 사용자의 클릭한 프로젝트의 북마크 조회 -->
  	<select id="getbookmark" parameterType="ants.com.member.model.ProjectMemberVo"
				resultType="ants.com.board.memBoard.model.BookmarkVo">
			select * from bookmark where req_id = #{reqId} and mem_id = #{memId}	
	</select>
	
	<!-- 로그인한 사용자의 북마크 추가 -->
	<insert id="insertbookmark" parameterType="ants.com.board.memBoard.model.BookmarkVo">
		INSERT INTO bookmark (
							    book_id,
							    issue_id,
							    req_id,
							    mem_id
								) VALUES (
								    BOOK_SEQ.nextval,
								    #{issueId},
								    #{reqId},
								    (select b.mem_name as mem_id
									from
									issue a, member b
									where a.mem_id = b.mem_id 
									and issue_id = #{issueId})
								)
	</insert>
	
	<!-- 로그인한 사용자의 북마크 삭제 -->
	<delete id="removebookmark" parameterType="ants.com.board.memBoard.model.BookmarkVo">
		DELETE FROM bookmark
		WHERE issue_id = #{issueId}
		    AND   req_id = #{reqId}
		    AND   mem_id = #{memId}
	</delete>
	
	
	<!-- 로그인한 사용자의 모든 북마크 조회 -->
  	<select id="getallbookmark" parameterType="ants.com.board.memBoard.model.AllBookMarkVo"
				resultType="ants.com.board.memBoard.model.AllBookMarkVo">
		SELECT Z.*
	      FROM (
	      	SELECT ROWNUM RNUM , 
	           	   S.*
		      FROM (		      
					select a.book_id, a.issue_id, a.req_id, a.mem_id, b.issue_title, b.issue_kind, 
					       to_char(b.reg_dt,'YYYY-MM-DD hh:mm') as reg_dt
					  from bookmark a, issue b 
					 where a.mem_id = b.mem_id and a.issue_id = b.issue_id
					      and a.mem_id = #{memId}
					      
					    <if test="searchKeyword != null and searchKeyword != ''">
				        <choose>				         	
				            <when test="searchCondition == 1">
								AND	b.issue_title LIKE '%' || #{searchKeyword} || '%'
							</when>
				     
						</choose>
					</if>				
					<if test = "issueKind != null and issueKind != ''">
							AND b.issue_kind = #{issueKind}
					</if>
					ORDER BY b.reg_dt desc
			  ) S
		
				 WHERE ROWNUM <![CDATA[ <= ]]> ${lastIndex} 
				
	      ) Z
	     <![CDATA[WHERE Z.RNUM > #{firstIndex}]]>		
	</select>
	
	
	<!-- 북마크 수 조회하기 -->	
	<select id="bookmarkPagingListCnt" parameterType="ants.com.board.memBoard.model.AllBookMarkVo"  
				resultType="int">
		select count(*) as totCnt
		from bookmark
		where mem_id = #{memId}
		
		<if test="searchKeyword != null and searchKeyword != ''">
		        <choose>
		            <when test="searchCondition == 1">
						AND	mem_id LIKE '%' || #{searchKeyword} || '%'
					</when>
		            <when test="searchCondition == 2">
						AND	issue_title LIKE '%' || #{searchKeyword} || '%'
					</when>	         
				</choose>
			</if>		
	</select>
  
</mapper>