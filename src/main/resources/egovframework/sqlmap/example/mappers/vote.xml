<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ants.com.board.vote.mapper.VoteMapper">

   <!-- 해당 프로젝트 투표리스트 가져오기 -->
	<select id="votelist" resultType ="ants.com.board.vote.model.VoteVo" parameterType="ants.com.board.vote.model.VoteVo">
 	
 		SELECT Z.*
	      FROM (
	      	SELECT ROWNUM RNUM , 
	           	   S.*
		      FROM (			
                
	                 select vote_title, vote_id, vote_totalno, to_char(vote_deadline, 'YYYY-MM-DD') as vote_deadline,
	                 		vote_status, category_id, req_id, mem_id,
	                 	  (select count(*) 
		                     from voteresult a, voteitem b, vote c 
						    where c.vote_id = b.vote_id and b.voteitem_id = a.voteitem_id and  b.vote_id = #{voteId}) as voted_no
	                 from vote 
	                 where req_id = #{reqId} 
	                   and del = 'N'
					     
					<if test="searchKeyword != null and searchKeyword != ''">
				        <choose>
				         	<when test="searchCondition == 1">
								AND	vote_title LIKE '%' || #{searchKeyword} || '%'
							</when>
				            <when test="searchCondition == 2">
								AND	mem_id LIKE '%' || #{searchKeyword} || '%'
							</when>
						</choose>
					</if>
				
					ORDER BY vote_deadline desc
			  ) S
		
				 WHERE ROWNUM <![CDATA[ <= ]]> ${lastIndex} 
				
	      ) Z
	     <![CDATA[WHERE Z.RNUM > #{firstIndex}]]>
				
	</select>


	<!-- 프로젝트에 따른 이슈게시글 수 조회하기 -->	
	<select id="votePagingListCnt" parameterType="ants.com.board.vote.model.VoteVo"  resultType="int">
		select count(*) as totCnt
		 from vote 
        where req_id = #{reqId} 
          and del = 'N'
		
		<if test="searchKeyword != null and searchKeyword != ''">
	        <choose>
	         	<when test="searchCondition == 1">
					AND	vote_title LIKE '%' || #{searchKeyword} || '%'
				</when>
	            <when test="searchCondition == 2">
					AND	mem_id LIKE '%' || #{searchKeyword} || '%'
				</when>
			</choose>
		</if>		
	</select>	
	
	<!-- 다음 투표id조회 (ajax로 등록하기위함) -->
	<select id ="getvoteid" resultType="String">
		SELECT VOTE_SEQ.nextval FROM DUAL
	</select>
	
	<!-- 투표테이블 작성 -->
	<insert id="insertvote" parameterType="ants.com.board.vote.model.VoteVo">
		INSERT INTO vote (
		    vote_id,
		    vote_totalno,
		    vote_title,
		    vote_deadline,
		    vote_status,
		    category_id,
		    req_id,
		    mem_id,
		    del
		) VALUES (
		    #{voteId},		    
			(select count(*)
			from projectmember
			where req_id =#{reqId}),		
		    #{voteTitle},
		    TO_DATE(#{voteDeadline},'YYYY/MM/DD'),
		    'ing',
		    '2',
		    #{reqId},
		    #{memId},
		    'N'
		)
	</insert>
	
	<!-- 투표아이템 테이블 작성 -->
	<insert id="insertvoteitem" parameterType="ants.com.board.vote.model.VoteItemVo">
		INSERT INTO voteitem (
				    voteitem_id,
				    voteitem_name,
				    vote_id,
				    vote_count
				    
				) VALUES (
				    vote_seq.nextval,
				    #{voteitemName},
				    #{voteId},
				    0
				)
	</insert>
	
	<!-- 투표아이템 상세 -->
	<select id="voteitemDetail"  parameterType="ants.com.board.vote.model.VoteVo"
							resultType="ants.com.board.vote.model.VoteItemVo">
		SELECT
		    voteitem_id,
		    voteitem_name,
		    vote_id,
		    vote_count
		FROM
		    voteitem
		WHERE
		    vote_id = ${voteId}
		ORDER BY voteitem_id
	</select>
	
	<!-- 투표 상세 -->
	<select id="voteDetail" parameterType="ants.com.board.vote.model.VoteVo"
				resultType="ants.com.board.vote.model.VoteVo">
		select vote_title, vote_id, vote_totalno, to_char(vote_deadline, 'YYYY-MM-DD') as vote_deadline,
                 vote_status, req_id, mem_id, 
                ( select count(*) 
                    from voteresult a, voteitem b, vote c 
				   where c.vote_id = b.vote_id and b.voteitem_id = a.voteitem_id and  b.vote_id = #{voteId}) as voted_no
          from vote 
          where vote_id = #{voteId}	
          order by vote_deadline 		
	</select>
	
	<!-- 투표결과 상세 -->
	<select id="voteresDetail" parameterType="ants.com.board.vote.model.VoteVo"
				resultType="ants.com.board.vote.model.VoteResultVo">
		SELECT
		    a.voteres_id,
		    a.voteitem_id,
		    a.mem_id	
		FROM
		    voteresult a, voteitem b
		WHERE a.voteitem_id = b.voteitem_id
		and b.vote_id = #{voteId}	
		and a.mem_id =#{memId}
	</select>
	
	
	
	
	<!-- 멤버 투표 -->
	<insert id="voteMember" parameterType="ants.com.board.vote.model.VoteResultVo">
		INSERT INTO voteresult (
							    voteres_id,
							    voteitem_id,
							    mem_id
								) VALUES (
								    VOTERES_SEQ.nextval,
								    #{voteitemId},
								    #{memId}
								)
	</insert>
	
	<!-- 투표 카운트 증가 -->
	<update id="cntupdate" parameterType="ants.com.board.vote.model.VoteResultVo">
			UPDATE voteitem 
			SET vote_count = 
					(SELECT count(*) 
					   FROM voteresult 
					  WHERE voteitem_id =  #{voteitemId})
			WHERE voteitem_id =  #{voteitemId}
		
	</update>

</mapper>